Note: Google Test filter = ServiceTrackerTestFixture.ServiceTrackerConcurrentOpenClose
[==========] Running 1 test from 1 test suite.
[----------] Global test environment set-up.
[----------] 1 test from ServiceTrackerTestFixture
[ RUN      ] ServiceTrackerTestFixture.ServiceTrackerConcurrentOpenClose
==================
WARNING: ThreadSanitizer: data race (pid=1274638)
  Read of size 8 at 0x7b440000b970 by thread T4:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 (libCppMicroServicesd.so.3.7.6+0x7b2eb)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Previous write of size 8 at 0x7b440000b970 by thread T6:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Location is heap block of size 264 at 0x7b440000b900 allocated by main thread:
    #0 operator new(unsigned long) ../../../../src/libsanitizer/tsan/tsan_new_delete.cpp:64 (libtsan.so.0+0x8499c)
    #1 ServiceTracker /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:76 (usFrameworkTests+0x1b6ba3)
    #2 make_unique<cppmicroservices::ServiceTracker<(anonymous namespace)::FooService>, cppmicroservices::BundleContext&, (anonymous namespace)::CustomFooTracker*> /usr/include/c++/10/bits/unique_ptr.h:962 (usFrameworkTests+0x1bd4d1)
    #3 ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:535 (usFrameworkTests+0x1bd4d1)
    #4 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #5 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T4 (tid=1274644, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T6 (tid=1274646, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

SUMMARY: ThreadSanitizer: data race /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 in cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&)
==================
==================
WARNING: ThreadSanitizer: data race (pid=1274638)
  Read of size 8 at 0x7b440000b970 by thread T1 (mutexes: write M685):
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 (libCppMicroServicesd.so.3.7.6+0x7b2eb)
    #1 Open /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:109 (usFrameworkTests+0x1ce58b)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:552 (usFrameworkTests+0x1a27ba)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a27ba)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a27ba)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a27ba)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a27ba)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a27ba)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a27ba)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a27ba)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a27ba)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Previous write of size 8 at 0x7b440000b970 by thread T6:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Location is heap block of size 264 at 0x7b440000b900 allocated by main thread:
    #0 operator new(unsigned long) ../../../../src/libsanitizer/tsan/tsan_new_delete.cpp:64 (libtsan.so.0+0x8499c)
    #1 ServiceTracker /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:76 (usFrameworkTests+0x1b6ba3)
    #2 make_unique<cppmicroservices::ServiceTracker<(anonymous namespace)::FooService>, cppmicroservices::BundleContext&, (anonymous namespace)::CustomFooTracker*> /usr/include/c++/10/bits/unique_ptr.h:962 (usFrameworkTests+0x1bd4d1)
    #3 ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:535 (usFrameworkTests+0x1bd4d1)
    #4 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #5 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Mutex M685 (0x7b440000b900) created at:
    #0 pthread_mutex_lock ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:4148 (libtsan.so.0+0x4db3a)
    #1 __gthread_mutex_lock /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:749 (usFrameworkTests+0x1d3bf4)
    #2 std::mutex::lock() /usr/include/c++/10/bits/std_mutex.h:100 (usFrameworkTests+0x1d3bf4)
    #3 std::unique_lock<std::mutex>::lock() /usr/include/c++/10/bits/unique_lock.h:138 (usFrameworkTests+0x1d3bf4)
    #4 std::unique_lock<std::mutex>::unique_lock(std::mutex&) /usr/include/c++/10/bits/unique_lock.h:68 (usFrameworkTests+0x1cdf02)
    #5 cppmicroservices::detail::MutexLockingStrategy<std::mutex>::UniqueLock::UniqueLock(cppmicroservices::detail::MutexLockingStrategy<std::mutex> const*) /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/Threads.h:81 (usFrameworkTests+0x1cdf02)
    #6 cppmicroservices::detail::MutexLockingStrategy<std::mutex>::Lock() const /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/Threads.h:153 (usFrameworkTests+0x1cdf02)
    #7 Open /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:97 (usFrameworkTests+0x1cdf02)
    #8 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:552 (usFrameworkTests+0x1a27ba)
    #9 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a27ba)
    #10 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a27ba)
    #11 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a27ba)
    #12 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a27ba)
    #13 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a27ba)
    #14 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a27ba)
    #15 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a27ba)
    #16 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a27ba)
    #17 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #18 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #19 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #20 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #21 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #22 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #23 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #24 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #25 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #26 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #27 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #28 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #29 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #30 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #31 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #32 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #33 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #34 <null> <null> (libstdc++.so.6+0xceecf)

  Thread T1 (tid=1274641, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T6 (tid=1274646, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

SUMMARY: ThreadSanitizer: data race /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 in cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&)
==================
==================
WARNING: ThreadSanitizer: data race (pid=1274638)
  Write of size 8 at 0x7b440000b970 by thread T6:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Previous read of size 8 at 0x7b440000b970 by thread T2:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 (libCppMicroServicesd.so.3.7.6+0x7b2eb)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Location is heap block of size 264 at 0x7b440000b900 allocated by main thread:
    #0 operator new(unsigned long) ../../../../src/libsanitizer/tsan/tsan_new_delete.cpp:64 (libtsan.so.0+0x8499c)
    #1 ServiceTracker /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:76 (usFrameworkTests+0x1b6ba3)
    #2 make_unique<cppmicroservices::ServiceTracker<(anonymous namespace)::FooService>, cppmicroservices::BundleContext&, (anonymous namespace)::CustomFooTracker*> /usr/include/c++/10/bits/unique_ptr.h:962 (usFrameworkTests+0x1bd4d1)
    #3 ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:535 (usFrameworkTests+0x1bd4d1)
    #4 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #5 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T6 (tid=1274646, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T2 (tid=1274642, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

SUMMARY: ThreadSanitizer: data race /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 in cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&)
==================
==================
WARNING: ThreadSanitizer: data race (pid=1274638)
  Write of size 8 at 0x7b440000b970 by thread T2:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Previous write of size 8 at 0x7b440000b970 by thread T6:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Location is heap block of size 264 at 0x7b440000b900 allocated by main thread:
    #0 operator new(unsigned long) ../../../../src/libsanitizer/tsan/tsan_new_delete.cpp:64 (libtsan.so.0+0x8499c)
    #1 ServiceTracker /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:76 (usFrameworkTests+0x1b6ba3)
    #2 make_unique<cppmicroservices::ServiceTracker<(anonymous namespace)::FooService>, cppmicroservices::BundleContext&, (anonymous namespace)::CustomFooTracker*> /usr/include/c++/10/bits/unique_ptr.h:962 (usFrameworkTests+0x1bd4d1)
    #3 ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:535 (usFrameworkTests+0x1bd4d1)
    #4 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #5 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T2 (tid=1274642, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T6 (tid=1274646, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

SUMMARY: ThreadSanitizer: data race /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 in cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&)
==================
==================
WARNING: ThreadSanitizer: data race (pid=1274638)
  Read of size 8 at 0x7b440000b970 by thread T8:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 (libCppMicroServicesd.so.3.7.6+0x7b2eb)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Previous write of size 8 at 0x7b440000b970 by thread T6:
    #0 cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&) /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:36 (libCppMicroServicesd.so.3.7.6+0x7b302)
    #1 Close /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:143 (usFrameworkTests+0x1cd40e)
    #2 operator() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:556 (usFrameworkTests+0x1a2774)
    #3 __invoke_impl<void, ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #4 __invoke<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a2774)
    #5 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a2774)
    #6 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a2774)
    #7 operator() /usr/include/c++/10/future:1373 (usFrameworkTests+0x1a2774)
    #8 __invoke_impl<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a2774)
    #9 __invoke_r<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>, std::__future_base::_Task_setter<std::unique_ptr<std::__future_base::_Result<void>, std::__future_base::_Result_base::_Deleter>, std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>&> /usr/include/c++/10/bits/invoke.h:113 (usFrameworkTests+0x1a2774)
    #10 _M_invoke /usr/include/c++/10/bits/std_function.h:292 (usFrameworkTests+0x1a2774)
    #11 std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>::operator()() const /usr/include/c++/10/bits/std_function.h:622 (usFrameworkTests+0x180b7c)
    #12 std::__future_base::_State_baseV2::_M_do_set(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*) /usr/include/c++/10/future:572 (usFrameworkTests+0x180b7c)
    #13 void std::__invoke_impl<void, void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::__invoke_memfun_deref, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:73 (usFrameworkTests+0x17f69c)
    #14 std::__invoke_result<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>::type std::__invoke<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x17f69c)
    #15 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#1}::operator()() const /usr/include/c++/10/mutex:717 (usFrameworkTests+0x17f69c)
    #16 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::operator()() const /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #17 std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&)::{lambda()#2}::_FUN() /usr/include/c++/10/mutex:722 (usFrameworkTests+0x17f69c)
    #18 pthread_once ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:1442 (libtsan.so.0+0x3ecd0)
    #19 __gthread_once /usr/include/x86_64-linux-gnu/c++/10/bits/gthr-default.h:700 (usFrameworkTests+0x183d63)
    #20 void std::call_once<void (std::__future_base::_State_baseV2::*)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*>(std::once_flag&, void (std::__future_base::_State_baseV2::*&&)(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*, bool*), std::__future_base::_State_baseV2*&&, std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>*&&, bool*&&) /usr/include/c++/10/mutex:729 (usFrameworkTests+0x183d63)
    #21 std::__future_base::_State_baseV2::_M_set_result(std::function<std::unique_ptr<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter> ()>, bool) /usr/include/c++/10/future:412 (usFrameworkTests+0x1a38ea)
    #22 operator() /usr/include/c++/10/future:1682 (usFrameworkTests+0x1a38ea)
    #23 __invoke_impl<void, std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:60 (usFrameworkTests+0x1a38ea)
    #24 __invoke<std::__future_base::_Async_state_impl<_BoundFn, _Res>::_Async_state_impl<std::thread::_Invoker<std::tuple<ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody()::<lambda()> > >, void>::<lambda()> > /usr/include/c++/10/bits/invoke.h:95 (usFrameworkTests+0x1a38ea)
    #25 _M_invoke<0> /usr/include/c++/10/thread:264 (usFrameworkTests+0x1a38ea)
    #26 operator() /usr/include/c++/10/thread:271 (usFrameworkTests+0x1a38ea)
    #27 _M_run /usr/include/c++/10/thread:215 (usFrameworkTests+0x1a38ea)
    #28 <null> <null> (libstdc++.so.6+0xceecf)

  Location is heap block of size 264 at 0x7b440000b900 allocated by main thread:
    #0 operator new(unsigned long) ../../../../src/libsanitizer/tsan/tsan_new_delete.cpp:64 (libtsan.so.0+0x8499c)
    #1 ServiceTracker /home/tcormack/dev/issue710/CppMicroServices/framework/include/cppmicroservices/detail/ServiceTracker.tpp:76 (usFrameworkTests+0x1b6ba3)
    #2 make_unique<cppmicroservices::ServiceTracker<(anonymous namespace)::FooService>, cppmicroservices::BundleContext&, (anonymous namespace)::CustomFooTracker*> /usr/include/c++/10/bits/unique_ptr.h:962 (usFrameworkTests+0x1bd4d1)
    #3 ServiceTrackerTestFixture_ServiceTrackerConcurrentOpenClose_Test::TestBody() /home/tcormack/dev/issue710/CppMicroServices/framework/test/gtest/ServiceTrackerTest.cpp:535 (usFrameworkTests+0x1bd4d1)
    #4 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #5 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T8 (tid=1274648, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

  Thread T6 (tid=1274646, running) created by main thread at:
    #0 pthread_create ../../../../src/libsanitizer/tsan/tsan_interceptors_posix.cpp:962 (libtsan.so.0+0x58ba2)
    #1 std::thread::_M_start_thread(std::unique_ptr<std::thread::_State, std::default_delete<std::thread::_State> >, void (*)()) <null> (libstdc++.so.6+0xcf144)
    #2 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) /home/tcormack/dev/issue710/CppMicroServices/third_party/googletest/googletest/src/gtest.cc:2631 (libgtestd.so.1.11.0+0xc1d72)
    #3 __libc_start_main ../csu/libc-start.c:308 (libc.so.6+0x23d09)

SUMMARY: ThreadSanitizer: data race /home/tcormack/dev/issue710/CppMicroServices/framework/src/service/ListenerToken.cpp:34 in cppmicroservices::ListenerToken::ListenerToken(cppmicroservices::ListenerToken&&)
==================
[       OK ] ServiceTrackerTestFixture.ServiceTrackerConcurrentOpenClose (203 ms)
[----------] 1 test from ServiceTrackerTestFixture (204 ms total)

[----------] Global test environment tear-down
[==========] 1 test from 1 test suite ran. (204 ms total)
[  PASSED  ] 1 test.
ThreadSanitizer: reported 5 warnings
